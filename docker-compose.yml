version: "3.9"

services:
  sap_backend:
    image: python:3.11-slim
    container_name: sap_backend
    working_dir: /app
    command: >
      bash -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000"
    environment:
      DATABASE_URL: mysql+pymysql://sapuser:sap_password@sap_db:3306/sap_reporting
    depends_on:
      - sap_db
    restart: always
    ports:
      - "8001:8000"
    volumes:
      - /mnt/Storage1/Containers/sap-reporting/backend:/app
    deploy:
      resources:
        limits:
          memory: "8179941376"
    labels:
      icon: http://192.168.0.133/DATA/Media/Icons/import.png

  sap_db:
    image: mariadb:10.6
    container_name: sap_db
    restart: always
    environment:
      MYSQL_DATABASE: sap_reporting
      MYSQL_USER: sapuser
      MYSQL_PASSWORD: sap_password
      MYSQL_ROOT_PASSWORD: root_password
    ports:
      - "3307:3306"
    volumes:
      - /mnt/Storage1/Containers/Databases/sap_db:/var/lib/mysql
    deploy:
      resources:
        limits:
          memory: "8179941376"
    labels:
      icon: http://192.168.0.133/DATA/Media/Icons/import.png

  sap_metabase:
    image: metabase/metabase:latest
    container_name: sap_metabase
    restart: always
    depends_on:
      - sap_db
    ports:
      - "3001:3000"
    environment:
      MB_DB_TYPE: h2
      MB_DB_FILE: /metabase-data/metabase.db
    volumes:
      - /mnt/Storage1/Containers/Databases/metabase:/metabase-data
    deploy:
      resources:
        limits:
          memory: "8179941376"
    labels:
      icon: http://192.168.0.133/DATA/Media/Icons/import.png

networks:
  default:
    name: sap-reporting_default

x-casaos:
  author: self
  category: self
  hostname: 192.168.0.133
  icon: ""
  index: /docs
  is_uncontrolled: false
  port_map: "8001"
  scheme: http
  title:
    custom: Metabase Data Upload
